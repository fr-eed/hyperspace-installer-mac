name: Build Installer

on:
  workflow_call:
    inputs:
      installer-bundle-version:
        description: 'Version of the installer bundle (e.g., 1.0.0)'
        required: true
        type: string
      mod-files:
        description: 'Space-separated paths to mod files (e.g., "mods/mod1.ftl mods/mod2.ftl")'
        required: true
        type: string
      installer-name:
        description: 'Installer display name (e.g., "My Awesome Mod Pack")'
        required: true
        type: string
      icon-path:
        description: 'Optional path to .icns icon file'
        required: false
        type: string

jobs:
  build-installers:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout calling repo
        uses: actions/checkout@v4

      - name: Checkout hyperspace-mac-autoinstaller
        uses: actions/checkout@v4
        with:
          repository: fr-eed/hyperspace-mac-autoinstaller
          path: hyperspace-mac-autoinstaller

      - name: Download executables
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd hyperspace-mac-autoinstaller
          ./scripts/downloads/download-executables.sh

      - name: Build installer for ${{ matrix.arch }}
        run: |
          cd hyperspace-mac-autoinstaller
          ./scripts/build/build-installer.sh \
            --executable ./release/${{ matrix.arch }}/HyperspaceInstaller \
            --mod-files "${{ inputs.mod-files }}" \
            --installer-name "${{ inputs.installer-name }}" \
            ${{ inputs.icon-path && format('--icon-path {0}', inputs.icon-path) || '' }} \
            --output-dir ../output/${{ matrix.arch }} \
            --arch "${{ matrix.arch }}"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.installer-name }}-${{ inputs.installer-bundle-version }}-${{ matrix.arch }}-dmg
          path: output/${{ matrix.arch }}/*.dmg
          if-no-files-found: warn
