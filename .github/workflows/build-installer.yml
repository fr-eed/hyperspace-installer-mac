name: Build Installer

on:
  workflow_call:
    inputs:
      installer-bundle-version:
        description: 'Version of the installer bundle (e.g., 1.0.0)'
        required: true
        type: string
      mod-files:
        description: 'Space-separated paths to mod files (e.g., "mods/mod1.ftl mods/mod2.ftl")'
        required: true
        type: string
      installer-name:
        description: 'Installer display name (e.g., "My Awesome Mod Pack")'
        required: true
        type: string
      icon-path:
        description: 'Optional path to .icns icon file'
        required: false
        type: string

jobs:
  build-installers:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout calling repo
        uses: actions/checkout@v4

      - name: Checkout hyperspace-installer-mac
        uses: actions/checkout@v4
        with:
          repository: fr-eed/hyperspace-installer-mac
          path: hyperspace-installer-mac

      - name: Download executables
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd hyperspace-installer-mac
          ./scripts/downloads/download-executables.sh

      - name: Download dependencies
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd hyperspace-installer-mac
          ./scripts/downloads/download-deps.sh

      - name: Build installer for ${{ matrix.arch }}
        run: |
          WORKSPACE_ROOT=$(pwd)
          ABSOLUTE_MODS=""
          for mod in ${{ inputs.mod-files }}; do
            ABSOLUTE_MODS="$ABSOLUTE_MODS $WORKSPACE_ROOT/$mod"
          done

          ICON_PATH=""
          if [ -n "${{ inputs.icon-path }}" ]; then
            ICON_PATH="$WORKSPACE_ROOT/${{ inputs.icon-path }}"
          fi

          BUILD_CMD="hyperspace-installer-mac/scripts/build/build-installer.sh \
            --executable $WORKSPACE_ROOT/hyperspace-installer-mac/release/${{ matrix.arch }}/HyperspaceInstaller \
            --mod-files \"$ABSOLUTE_MODS\" \
            --installer-name \"${{ inputs.installer-name }}\" \
            --installer-bundle-version \"${{ inputs.installer-bundle-version }}\" \
            --output-dir $WORKSPACE_ROOT/output/${{ matrix.arch }} \
            --arch \"${{ matrix.arch }}\""

          if [ -n "$ICON_PATH" ]; then
            BUILD_CMD="$BUILD_CMD --icon-path \"$ICON_PATH\""
          fi

          eval "$BUILD_CMD"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.installer-name }}-${{ inputs.installer-bundle-version }}-${{ matrix.arch }}-dmg
          path: output/${{ matrix.arch }}/*.dmg
          if-no-files-found: warn
