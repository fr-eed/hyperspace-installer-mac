name: Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Download dependencies
        env:
          GH_TOKEN: ${{ github.token }}
        run: ./scripts/downloads/download-deps.sh

      - name: Build executables
        run: ./scripts/build/build-executable-all.sh

      - name: Run tests arm64
        run: swift test

      - name: Package executables
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          cd release
          tar -czf "HyperspaceInstaller-$VERSION-executables.tar.gz" x86_64/HyperspaceInstaller arm64/HyperspaceInstaller
          ls -lh "HyperspaceInstaller-$VERSION-executables.tar.gz"

      - name: Get latest tag for changelog
        id: latest_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Generate release body from template
        id: release_body
        run: |
          BODY=$(cat .github/RELEASE_BODY.md)
          BODY="${BODY//LATEST_TAG/${{ steps.latest_tag.outputs.LATEST_TAG }}}"
          BODY="${BODY//CURRENT_VERSION/v${{ steps.version.outputs.VERSION }}}"
          echo "BODY<<EOF" >> $GITHUB_ENV
          echo "$BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          files: release/HyperspaceInstaller-${{ steps.version.outputs.VERSION }}-executables.tar.gz
          body: ${{ env.BODY }}

  build-basemod:
    needs: build-and-release
    uses: fr-eed/hyperspace-installer-mac/.github/workflows/release-basemod-installer.yml@main
    with:
      release-tag: v${{ needs.build-and-release.outputs.version }}
