name: Release Basemod Installer

on:
  workflow_call:
    inputs:
      installer-bundle-version:
        description: 'Version of the installer bundle'
        required: true
        type: string
      release-tag:
        description: 'GitHub release tag to attach DMGs to'
        required: false
        type: string

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Download Hyperspace.ftl from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p external
          gh release download -R fr-eed/FTL-Hyperspace-Dino -p "*-MacOS.zip" -O /tmp/hyperspace.zip
          unzip -q /tmp/hyperspace.zip -d /tmp/hyperspace
          mv /tmp/hyperspace/Hyperspace.ftl external/Hyperspace.ftl

      - name: Build installer for ${{ matrix.arch }}
        uses: fr-eed/hyperspace-installer-mac/actions/build-installer@main
        with:
          arch: ${{ matrix.arch }}
          installer-bundle-version: ${{ inputs.installer-bundle-version }}
          installer-name: "Hyperspace Installer"
          mod-files: "${{ github.workspace }}/external/Hyperspace.ftl"
          icon-path: "${{ github.workspace }}/HSInstaller.icns"

      - name: Upload DMG to release
        if: inputs.release-tag != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release-tag }}
          files: output/${{ matrix.arch }}/*.dmg
